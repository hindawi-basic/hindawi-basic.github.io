<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
<link
href='http://fonts.googleapis.com/css?family=Roboto+Slab:300,400,700|Roboto:400,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Merriweather:400,400italic,700' rel='stylesheet' type='text/css'>
<link rel='stylesheet' type='text/css' href="style.css">
  <meta name="viewport"
  content="width=device-width,
  minimum-scale=1.0, maximum-scale=1.0" />
<link rel="alternate" type="application/atom+xml"
    href="http://stevehanov.ca/blog/?atom"
    title="RSS" />
<title>qb.js: An implementation of QBASIC in Javascript </title>
<style>
</style>
</head>
<body>
    <script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script src="Layout2.js"></script>
        <div class=blog-title>
        <a href="/blog"><img class=logo src="http://stevehanov.ca/blog/caption.png"
        alt="Steve Hanov's Blog"></a><br>
        I know how to make and sell software online, and I can share my tips
        with you.<br>
        <a href="mailto:steve.hanov@gmail.com">Email</a>
        | <a href="https://twitter.com/smhanov">Twitter</a>
        | <a
        href="http://www.linkedin.com/pub/steve-hanov/10/430/410">LinkedIn</a>
        | <a href="http://stevehanov.ca/comics">Comics</a>
        | <a href="/blog">All articles</a>
    </div>
    <div class=main id=main style="visibility:hidden">
    <div class="main-entry cols-2">
                <div class=navigate>
                            <a class=nav-left href="?id=93">&lt;</a>
                                        <a class=nav-right href="?id=95">&gt;</a>
                    </div>
        <h1 id=blogTitle class="blogTitle">qb.js: An implementation of QBASIC in Javascript </h1>
        <div class=blogDate>Posted nine years ago</div>
        <div id=blogText>
        

If your browser supports the proposed CANVAS tag, you will see a screen below containing a BASIC program.
<p>
<script type="text/javascript" src="http://stevehanov.ca/qb.js/qb.js"></script>
<p>
<break>
Many programmers seldom think about how their compiler or scripting language is implemented. To them, it is a tool, and the less it gets in the way, the better. However, for a craftsman, knowing how your tools work can help you do a better job. It helps to think on several levels at once. Take this code, for example:
<p>
<pre>
function createDummyString( length )
{
    var result = "";
    for ( var i = 0; i < length; i++ ) {
        result = result + " "; 
    }

    return result;
}
</pre>
<p>
<img src="http://unrealitymag.com/wp-content/uploads/2009/02/neotitle.jpg" align=right>In some languages, strings are immutable, so <tt>result</tt> could be repeatedly created, copied, and destroyed millions of times in this one function call.
<p>
Those who are familiar with compilers have the ability to think on another level. For them, visible about 10 cm behind the computer screen is a whole other level of code, which contains how the programming language might be implemented. Beyond that, further in the distance, lies assembly language, with its precarious branch prediction, happy cache hits, and misrable misses.

<p>
Here is an implementation of QBASIC in Javascript. In this next series of blog entries, we will explore its inner workings, covering all parts of the compilation process.

<h3>What works</h3>
<p>Only text mode is supported. The most common commands (enough to run nibbles) are implemented. These include:
<ul>
<li>Subs and functions
<li>Arrays
<li>User types
<li>Shared variables
<li>Loops
<li>Input from screen
</ul>

<h3>What doesn't work</h3>
<ul>
<li>Graphics modes are not supported
<li>No statements are allowed on the same line as IF/THEN
<li>Line numbers are not supported
<li>Only the built-in functions used by NIBBLES.BAS are implemented
<li>All subroutines and functions must be declared using DECLARE
</ul>

<p>
This is <i>far</i> from being done. In the comments, <b>AC0KG points out that P=1-1 doesn't work. </b> 
<p>
In short, it would need another 50 or 100 hours of work and there is no reason to do this.

<p>
The parser is slow because we are using a simple Earley parser. <a href="../qb.js/EarleyParser.js">(EarleyParser.js)</a>. Update in 2014: If I ever do this again I would use a "Packrat" parser.
<p>

<h3>License</h3>
License is GPL v3.

<h2>Overview of the system</h2>
<p>
The compiler takes your BASIC program and converts it into a list of user data types, data from DATA statements, and bytecode statements. Here's pretty picture of the previous sentence:
<p align=center><img src="images/comp-stages.png"/></p>

<p>
If you just look at the Javascript source it will be confusing to figure out what goes where. So here is a map of all the important "classes" of the system:

<p align=center><img src="images/comp-modules.png"/></p>


<h3>Console</h3>
<a href="../qb.js/console.js">(Source)</a> A canvas that represents the screen and captures keyboard input

<h3>Virtual machine</h3>
<a href="../qb.js/virtualmachine.js">(Source)</a> The virtual machine executes bytecode. The bytecode instructions may manipulate the stack, jump to a new address, or use the console functions. They may also execute system functions (such as LEFT$) or system subroutines (such as CLS).

<h3>Types</h3>
<a href="../qb.js/types.js">(Source)</a> Each type (single, double, integer, long, array, user) has functions to create an initial value, or to copy a value into a variable. Upon a copy, for instance, the integer type performs rounding and truncates the value to 16 bits.

<h3>Codegenerator</h3>
<a href="../qb.js/CodeGenerator.js">(Source)</a> The code generator visits each node of the abstract syntax tree abd generates bytecode for it. It uses the type information added by the TypeChecker as an aid.

<h3>TypeChecker</h3>
<a href="../qb.js/TypeChecker.js">(Source)</a> The TypeChecker's job is to catch any errors before we try compiling. Without it, you could write a program that tries to multiply an array by the string "George". Then the virtual machine would say "WTF?!" and crash. It fills in the type for any expression in the syntax tree.

<h3>GlrParser</h3>
<a href="../qb.js/GlrParser.js">(Source)</a> The GlrParser is an implementation of Tomita's GLR parser. It uses a RuleSet to parse the program into an abstract syntax tree.
<p>
Unfortunately, there is a problem with my implementation of the GLR parser. I think I know how to solve it, but at the moment, the system uses the very slow, but concise Earley parser, in <a href="../qb.js/EarleyParser.js">EarleyParser.js</a> EarleyParser.js.

<h3>Tokenizer</h3>
<a href="../qb.js/Tokenizer.js">(Source)</a> If you try to use javascript's built in Regex object for splitting text into tokens, you will soon pull your hair out and run screaming through the halls. Instead, the tokenizer implements a simple Thompson NFA with lazy evaluation. In some cases, this technique is faster than Javascript's own RegEx functions!

<h3>Ruleset</h3>
<a href="../qb.js/RuleSet.js">(Source)</a> The ruleset contains grammar rules. In addition, it can remove redundant rules, and compute the FIRST and FOLLOW sets.

<h3>Ruleparser</h3>
<a href="../qb.js/RuleParser.js">(Source)</a> The RuleParser is implemented on top of the RuleSet. It uses the parser to parse rules, and transforms them to add goodies like comma separated lists, kleene star, and alternation operators. But it's main purpose is to allow me to say, "My parser uses itself to parse its own rules!"
<h3>QBasic</h3>
<a href="../qb.js/qbasic.js">(Source)</a> Finally, qbasic.js contains all of the grammar rules and Abstract Syntax Tree nodes for BASIC programs. 
<hr/>
<p>
<h2>Virtual machine</h2>
<p>
The most straightforward way of creating a basic compiler in javascript is to directly translate the basic into javascript functions. But this approach will not work for two reasons. First, there is "goto" which, although it is a reserved word, is not yet in Javascript. (Obviously, ECMAScript community finds "with", prototype inheritance, and the rules of the 'this' keyword to be far less confusing than allowing "goto"). It is possible to <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.42.1485&rep=rep1&type=pdf">automatically move statements around to eliminate GOTO</a>, but you don't want to go there.

<p> 
The other problem is that browsers tend to freeze until javascript programs finish running. To avoid freezing the browser until the program ends, we break the program into small chunks, and execute a few of those chunks every so often using a javascript timer. This gives the appearance of a running program and doesn't freeze the browser.
<p>
Bytecode solves both of those problems. By breaking the program into bytecode instructions, we can implement goto by just changing which instruction we are going to execute next. We can also suspend execution any time to allow the user to interact with the browser.
<p>
The virtual machine executes programs, which consist of types, an array of instructions, and a set of variable names which are shared. It has some data:
<p>
<ul>
<li><em>pc, the program counter</em> (the index of the next instruction to execute)

<li><em>a stack of frames</em>. A frame maps variable names to their values. Each time a function is called, the frame is added to the stack. Each time it returns, the frame is removed, thus destroying all local variables.

<li><em>an execution stack</em>. The instructions can manipulate this stack. Two types of things can be pushed onto the stack: either a value (which is.a javascript string, number, or null), or a reference to a value (which can be  the ScalarVariable or ArrayVariable objects).
</ul>
<p>

<h2>Executing Instructions</h2>

<p>
Javascript excels at looking up things in objects and mapping strings to functions. This makes the virtual machine instruction lookup very efficient.

<p>
All of the information about each instruction is stored in a single object, called "Instructions". That means we can run dispatch instructions very simply, leaving the heavy work of figuring out where the code is to the javascript runtime:

<pre>
while( this.pc < this.instructions.length ) {
    var next = this.instructions[this.pc++];
    next.instr.execute( this, instr.arg );
}
</pre>

<p>
Each instruction can manipulate the stack, set variables, or change the <tt>pc</tt> to jump to another location.

<h2>Example</h2>
Here's some basic code:
<p>
<pre>
A = 1
B = 2
PRINT A + B
</pre>

<p>
And here's the bytecode produced to run the above statements:
<p>
<pre>
   ' L1 A = 1
[0] pushconst 1
[1] pushref A
[2] assign
   ' L2 B = 2
[3] pushconst 2
[4] pushref B
[5] assign
   ' L3 PRINT A + B
[6] pushvalue A
[7] pushvalue B
[8] +
[9] syscall print
[10] pushconst 'n'
[11] syscall print
[12] ret
[13] end
</pre>

<p>
PUSHCONST 1 pushes a number 1 onto the stack. PUSHREF A is a bit complicated, though. It pushes a reference to variable A onto the stack. Since there was no prior value of A, it has to create one with the default type of SINGLE and adds the mapping from the name "A" to that variable. After all that housekeepint, it does the push. The state of the virtual machine looks like this:
<p align=center><img src="images/vm-state1.png"></p>
<p>
The ASSIGN instruction expects a reference and a constant on the stack. It removes them, and assigns the reference to the variable. Here's the actual javascript implementation of the instruction:
<p>
<pre>
    ASSIGN: {
        name: "assign",
        numArgs: 0,
        execute: function( vm, arg )
        {
            // Copy the value into the variable reference.
            // Stack: left hand side: variable reference
            // right hand side: value to assign.

            var lhs = vm.stack.pop();
            var rhs = vm.stack.pop();

            lhs.value = lhs.type.copy( rhs );
        }
</pre>
<p>
Let's look at instructions 6 to 8. We've seen PUSHREF, and PUSHCONST, now what's PUSHVALUE? This instructions the variable name and pushes its current value on the stack. After instruction 7, the state of the virtual machine is this:

<p align=center><img src="images/vm-state2.png" /></p>
<p>
All of the instructions are pretty simple to implement. Here's how the "+" instruction works. Thanks to Javascript, it works for both strings and numbers.
<p>
<pre>
    "+": {
        name: "+",
        numArgs: 0,
        execute: function( vm, arg )
        {
            var rhs = vm.stack.pop();
            var lhs = vm.stack.pop();
            vm.stack.push( lhs + rhs );
        }
    },
</pre>
<p>
Finally, we call the "print" system function, which just pops the result off the stack and displays it on the screen.
<p>
Here are the other instructions:
<h3>ASSIGN</h3>
Pop two things off the stack, and assign the value to the reference.

<h3>MEMBER_VALUE</h3>
Pop the reference to the user defined structure, and push the value of the named member.

<h3>MEMBER_DEREF</h3>
Like MEMBER_VALUE, but pushes a reference to the named mamber.

<h3>ARRAY_DEREF</h3>
Pop the array indices, and push a reference to the given location of the array.

<h3>PUSHCONST</h3>
Push the literal value onto the stack.

<h3>RET</h3>
destroy the current variable map, and restore the previous one, jumping to the previous value of PC.

<h3>GOSUB</h3>
Like call, but instead of using a new variable map, copy the current one.

<h3>CALL</h3>
Create a new, empty variable map, store PC in it, and jump to the given location.

<h3>JMP</h3>
Immediately jump to the given location.

<h3>BNZ</h3>
pop the top of the stack and jump to the given location if it is non-zero

<h3>MOD, /, *, +, -, AND, OR, NOT, &lt;&gt;, &gt;=, &lt;=, &lt;, &gt;, =</h3>
Pop one or two arguments off the top of the stack, perform the given operation, and push the result onto the stack.

<h3>BZ</h3>
Pop the top of the stack and jump to the given location if it is zero.

<h3>END</h3>
Halt the VM.

<h3>NEW</h3>
Create a new unnamed instance of the variable of the specified type, and push it onto the stack.

<h3>PUSHTYPE</h3>
Push the named type onto the stack

<h3>PUSHVALUE</h3>
Push the value of the given variable onto the stack.

<h3>PUSHREF</h3>
Push a reference to the given variable onto the stack.

<h3>POP</h3>
Pop the stack and discard

<h3>POPVAL</h3>
Set the given variable's value to be the value at the top of the stack.

<h3>RESTORE</h3>
Set data index to the given value

<h3>COPYTOP</h3>
duplicate the top of the stack.

<h3>FORLOOP</h3>
Using counter, step, and end value on the stack, determine if the for loop should continue. If not, jump to the given location.

<h3>SYSCALL</h3>
Call the given system function or subroutine (eg, LOCATE or CLS or LEFT$)

<h2>Console</h2>
<p>The console performs these functions:
<ul>
<li>Printing to the screen
<li>Converting QBASIC's colour codes to HTML colours
<li>Keeping track of cursor position
<li>Blinking the cursor
<li>Allowing line oriented user input
<li>Keeping a keyboard buffer for INKEY$, and converting DOM keycodes to qbasic keyboard codes.
</ul>

<p>
The console uses an HTML Canvas object for display. It has <a href="../qb.js/charmap.png">an image of every character in the IBM character set</a>. When you want to print something, it first draws a solid rectangle of the background colour at that position. Then it copies the character's image, leaving alone any transparent pixels.
<p>
In input mode, anything the user types is displayed on the screen and copied to a buffer. When you hit enter, input mode ends, and a completion function is called to restart the virtual machine and process the input.
<p>
While not in input mode, and you hit a key, it is converted into a QBASIC character code and added to the keyboard buffer. This buffer is used for the INKEY$ function.

<h2>Until next time</h2>
<p>
We've covered the runtime system of our virtual computer. We've left out how to handle arrays and function calls. For those features, you'll have to look up how the ARRAY_DEREF and CALL instructions are implemented, in <a href="../qb.js/virtualmachine.js">virtualmachine.js</a>.

<p>



<h2>Further reading...</h2>
<ul>
<li><a href="http://stevehanov.ca/blog/?id=79">How QBASIC almost got me killed</a>
<li><a href="http://stevehanov.ca/blog/?id=67">Game theory, Salary negotiation, and Programmers</a>
<li><a href="http://stevehanov.ca/blog/?id=56">How a programmer reads your resume</a>
<li><a href="http://stevehanov.ca/blog/?id=68">When programmers design web sites...</a>

</ul>        </div>
    </div>
        <div class=comment>
            <b>Steve Hanov</b> makes a living working on 
            <a href="http://rhymebrain.com">Rhymebrain.com</a>,
            <a href="http://pricemonkey.ca">PriceMonkey.ca</a>,
            <a
            href="http://www.websequencediagrams.com">www.websequencediagrams.com</a>,
            and <a href="http://zwibbler.com">Zwibbler.com</a>. He lives in 
            Waterloo, Canada.
        </div>
        <div class=comment>
            <div id=writecomment-div>
                Post comment<br>
                <input type=text style="width:100%" onfocus="writeComment()">
            </div>
            <form id=commentForm action="/blog/index.php" method=POST onsubmit="return validateCommentForm(this);">
                <span style="visibility:hidden;position:absolute;"> Your Email (Not displayed): <input type=text name="email"/></span>
                Post comment<br>
                <textarea style="width:100%" cols=60 id=comment-text name=comment rows=10 wrap=soft ></textarea><br>
                <br>
                Real Name
                <br>
                <input type=text name=displayname id="realname" />
                <br>
                Editing Password (Optional): <br>
                <input type=text name=editpassword><br>
                <span style="font-size: 10px;color:#888">
                Choose an edit password if you want to be able to edit or delete
                your comment later.
                </span>
                <br>
                <input type=submit value="Post Comment" />
                <input type=button value="Cancel" onclick="cancelComment()"/>
                <input type=hidden name=id value="92">
            </form>
        
        </div>
                    <div class=comment onmouseenter="mouseentercomment(5873)"
                    onmouseleave="mouseleavecomment(5873)" 
                    id=wholecomment5873 >
                    <a href="javascript:editcomment(5873)"
                        class=edit-comment id=edit-comment-5873>edit</a>
                <div class=comment-name>Steve Hanov </div>
                <div class=comment-date>nine months ago </div>
                <div class=comment-text id="commentText5873">This is just a reminder that my qbasic implementation is very incomplete and it probably won't run anything other than NIBBLES.BAS. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(5869)"
                    onmouseleave="mouseleavecomment(5869)" 
                    id=wholecomment5869 >
                    <a href="javascript:editcomment(5869)"
                        class=edit-comment id=edit-comment-5869>edit</a>
                <div class=comment-name>gg </div>
                <div class=comment-date>nine months ago </div>
                <div class=comment-text id="commentText5869">noice </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(5669)"
                    onmouseleave="mouseleavecomment(5669)" 
                    id=wholecomment5669 >
                    <a href="javascript:editcomment(5669)"
                        class=edit-comment id=edit-comment-5669>edit</a>
                <div class=comment-name>Nacho </div>
                <div class=comment-date>one year ago </div>
                <div class=comment-text id="commentText5669">Great Job!
<p>

<p>
Still, there is something wrong with the WHILE command: this simple program does not behave properly:
<p>

<p>
' Challenge 002: Side Of The Street
<p>
' 
<p>
' Answer = &quot;DERECHA&quot; if input is even, IZQUIERDA if it is ODD
<p>
' 0 to end
<p>
 
<p>
INPUT n
<p>

<p>
WHILE n &lt;&gt; 0
<p>
    IF n MOD 2 = 0 THEN
<p>
        PRINT &quot;DERECHA.&quot;
<p>
    ELSE
<p>
        PRINT &quot;IZQUIERDA.&quot;
<p>
    END IF
<p>

<p>
    INPUT n
<p>
WEND
<p>
 </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2999)"
                    onmouseleave="mouseleavecomment(2999)" 
                    id=wholecomment2999 >
                    <a href="javascript:editcomment(2999)"
                        class=edit-comment id=edit-comment-2999>edit</a>
                <div class=comment-name>Caue Rego </div>
                <div class=comment-date>five years ago </div>
                <div class=comment-text id="commentText2999">I got a very old basic game of mine which simply doesn't run here.
<p>

<p>
I stripped just the COMMAND$ part of it, really a few lines of code, and it does run on qb64.net
<p>

<p>
Would you be interested in grabbing it and making it work? I'd love to be able to play with it in your emulator, as it is much faster than qb64! </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2989)"
                    onmouseleave="mouseleavecomment(2989)" 
                    id=wholecomment2989 >
                    <a href="javascript:editcomment(2989)"
                        class=edit-comment id=edit-comment-2989>edit</a>
                <div class=comment-name>taylor swift </div>
                <div class=comment-date>five years ago </div>
                <div class=comment-text id="commentText2989">hey just wanted to tell these are not accepting 
<p>
a. REM statements
<p>
b.  CLS statements
<p>
c. IF-THEN-ENDIF statements
<p>
d. IF- THEN- ELSE- ENDIF statements
<p>
but anyway it has helped me a lot for preparing for exams and hats off to you creator
<p>
 </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2974)"
                    onmouseleave="mouseleavecomment(2974)" 
                    id=wholecomment2974 >
                    <a href="javascript:editcomment(2974)"
                        class=edit-comment id=edit-comment-2974>edit</a>
                <div class=comment-name>De Lorean </div>
                <div class=comment-date>five years ago </div>
                <div class=comment-text id="commentText2974">I also saw that immutable string comment ...  :D , Ignorance duly noted. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2667)"
                    onmouseleave="mouseleavecomment(2667)" 
                    id=wholecomment2667 >
                    <a href="javascript:editcomment(2667)"
                        class=edit-comment id=edit-comment-2667>edit</a>
                <div class=comment-name>Jesse Ramirez Silva </div>
                <div class=comment-date>seven years ago </div>
                <div class=comment-text id="commentText2667">Nice article. Regards from BigField in Rio/Brazil. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2432)"
                    onmouseleave="mouseleavecomment(2432)" 
                    id=wholecomment2432 >
                    <a href="javascript:editcomment(2432)"
                        class=edit-comment id=edit-comment-2432>edit</a>
                <div class=comment-name>Majid </div>
                <div class=comment-date>eight years ago </div>
                <div class=comment-text id="commentText2432">Hi dear Steve.<p><p>I copy this page and qb.js into my htdocs , when i enter submit the program of printing &quot;hello&quot; , it was the result:<p><p>Bad token!<p><p>Parse failed.<p><p>Bad token!<p><p>Parse failed.<p><p>Bad token!<p><p>Parse failed.<p><p>Bad token!<p><p>Parse failed.<p><p>Bad token!<p><p>Parse failed.<p><p>Program successfully parsed. 3 statements.<p><p>Program successfully parsed. 3 statements.<p><p>Program successfully parsed. 1 statements.<p><p>pls help me. should i add some php or js codes?<p><p> </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2431)"
                    onmouseleave="mouseleavecomment(2431)" 
                    id=wholecomment2431 >
                    <a href="javascript:editcomment(2431)"
                        class=edit-comment id=edit-comment-2431>edit</a>
                <div class=comment-name>Majid </div>
                <div class=comment-date>eight years ago </div>
                <div class=comment-text id="commentText2431">Hi dear Steve.
<p>
i am not familiar with java script enough. please help me how could i use this project for my school site.
<p>
i just download this page but when i click on button for compiling , it dosnt work. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2430)"
                    onmouseleave="mouseleavecomment(2430)" 
                    id=wholecomment2430 >
                    <a href="javascript:editcomment(2430)"
                        class=edit-comment id=edit-comment-2430>edit</a>
                <div class=comment-name>Steve Hanov </div>
                <div class=comment-date>eight years ago </div>
                <div class=comment-text id="commentText2430">I think the code is sufficiently documented. The sources for most compilers, including qb.js, are almost the same. I assume that anyone reading the code is already familiar with lexing, parsing, syntax trees, and QBASIC.  </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2361)"
                    onmouseleave="mouseleavecomment(2361)" 
                    id=wholecomment2361 >
                    <a href="javascript:editcomment(2361)"
                        class=edit-comment id=edit-comment-2361>edit</a>
                <div class=comment-name>Angelo </div>
                <div class=comment-date>eight years ago </div>
                <div class=comment-text id="commentText2361">OWWWWWWWWWWWWWWWW
<p>
My respects! </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(2245)"
                    onmouseleave="mouseleavecomment(2245)" 
                    id=wholecomment2245 >
                    <a href="javascript:editcomment(2245)"
                        class=edit-comment id=edit-comment-2245>edit</a>
                <div class=comment-name>Daniel Reed </div>
                <div class=comment-date>eight years ago </div>
                <div class=comment-text id="commentText2245">You should really try code documentation sometime, it really works wonders for the readability of your code....  </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1896)"
                    onmouseleave="mouseleavecomment(1896)" 
                    id=wholecomment1896 >
                    <a href="javascript:editcomment(1896)"
                        class=edit-comment id=edit-comment-1896>edit</a>
                <div class=comment-name>The Wife (Alice) </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1896">Back off Geurts he's mine! </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1895)"
                    onmouseleave="mouseleavecomment(1895)" 
                    id=wholecomment1895 >
                    <a href="javascript:editcomment(1895)"
                        class=edit-comment id=edit-comment-1895>edit</a>
                <div class=comment-name>Jeff Geurts </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1895">I like you. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1887)"
                    onmouseleave="mouseleavecomment(1887)" 
                    id=wholecomment1887 >
                    <a href="javascript:editcomment(1887)"
                        class=edit-comment id=edit-comment-1887>edit</a>
                <div class=comment-name>Nate </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1887">Thank you! From now on all my code will be in Basic. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1837)"
                    onmouseleave="mouseleavecomment(1837)" 
                    id=wholecomment1837 >
                    <a href="javascript:editcomment(1837)"
                        class=edit-comment id=edit-comment-1837>edit</a>
                <div class=comment-name>AC0KG </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1837">Looks like the parser has a bug:
<p>

<p>
This fails:
<p>
P=1-1
<p>

<p>
While these work:
<p>

<p>
P=1+1
<p>
P=1-(1)
<p>

<p>
 </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1832)"
                    onmouseleave="mouseleavecomment(1832)" 
                    id=wholecomment1832 >
                    <a href="javascript:editcomment(1832)"
                        class=edit-comment id=edit-comment-1832>edit</a>
                <div class=comment-name>fakejoe </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1832">Wicked Cool. Wayyyyy too cool.
<p>

<p>
What have you done Anakin!
<p>
You just gave the Emperor a new galaxy to conqu.. I mean repackage their all time high revenue legendary programs ;-) </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1830)"
                    onmouseleave="mouseleavecomment(1830)" 
                    id=wholecomment1830 >
                    <a href="javascript:editcomment(1830)"
                        class=edit-comment id=edit-comment-1830>edit</a>
                <div class=comment-name>wilq32 </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1830">Great one! Congrats :) </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1829)"
                    onmouseleave="mouseleavecomment(1829)" 
                    id=wholecomment1829 >
                    <a href="javascript:editcomment(1829)"
                        class=edit-comment id=edit-comment-1829>edit</a>
                <div class=comment-name>Brian McKelvey </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1829">This is inspirational!  I hope I can learn quite a bit from examining your implementation.  That, and there's a ton of nostalgia for me in QBasic... :)
<p>

<p>
I recently wrote an interpreter for an old RPN stack-based language called Iptscrae (Pig-latin for &quot;Script&quot;).  It somewhat resembles Forth.  It was a custom scripting language for an old avatar-chat system for which I'm writing a new open source client in Flash.  Source is available on github: www.github.com/theturtle32/OpenPalace
<p>

<p>
It's my first attempt at writing my own language interpreter.  Some of the principles seem to be the same as what you did, which makes me feel good about it, but I love the idea of doing it as a virtual machine.  I don't think it would take much to refactor it as such... So exciting!
<p>

<p>
Thanks so much for creating this!! </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1825)"
                    onmouseleave="mouseleavecomment(1825)" 
                    id=wholecomment1825 >
                    <a href="javascript:editcomment(1825)"
                        class=edit-comment id=edit-comment-1825>edit</a>
                <div class=comment-name>Swart </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1825">this is madness! XD </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1824)"
                    onmouseleave="mouseleavecomment(1824)" 
                    id=wholecomment1824 >
                    <a href="javascript:editcomment(1824)"
                        class=edit-comment id=edit-comment-1824>edit</a>
                <div class=comment-name>Jake </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1824">Thanks for a great posting - very useful and informative
<p>

<p>
I was looking at doing a *very* similar project for another version of BASIC and was thinking of modelling the interpreter along similar lines
<p>

<p>
I'm glad I wasn't barking up the wrong tree - Cheers </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1823)"
                    onmouseleave="mouseleavecomment(1823)" 
                    id=wholecomment1823 >
                    <a href="javascript:editcomment(1823)"
                        class=edit-comment id=edit-comment-1823>edit</a>
                <div class=comment-name>nhyone </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1823">I was thinking of re-implementing some old BASIC games in JavaScript. Looks like writing a whole VM to do it is much cooler! :-D </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1817)"
                    onmouseleave="mouseleavecomment(1817)" 
                    id=wholecomment1817 >
                    <a href="javascript:editcomment(1817)"
                        class=edit-comment id=edit-comment-1817>edit</a>
                <div class=comment-name>Michael </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1817">STR$(curLevel) -&gt; str$ needs a left space (&quot; &quot;)! </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1815)"
                    onmouseleave="mouseleavecomment(1815)" 
                    id=wholecomment1815 >
                    <a href="javascript:editcomment(1815)"
                        class=edit-comment id=edit-comment-1815>edit</a>
                <div class=comment-name>Markus </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1815">This is awesome. Reminds me of my first steps with computers :) </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1814)"
                    onmouseleave="mouseleavecomment(1814)" 
                    id=wholecomment1814 >
                    <a href="javascript:editcomment(1814)"
                        class=edit-comment id=edit-comment-1814>edit</a>
                <div class=comment-name>meanroy </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1814">Great!
<p>
Bill went on to rule the world after HE wrote a Basic, what are your plans?
<p>

<p>
;-)
<p>

<p>
Roy. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1813)"
                    onmouseleave="mouseleavecomment(1813)" 
                    id=wholecomment1813 >
                    <a href="javascript:editcomment(1813)"
                        class=edit-comment id=edit-comment-1813>edit</a>
                <div class=comment-name>Steve  </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1813">Corrected. </div>
            </div>
                    <div class=comment onmouseenter="mouseentercomment(1812)"
                    onmouseleave="mouseleavecomment(1812)" 
                    id=wholecomment1812 >
                    <a href="javascript:editcomment(1812)"
                        class=edit-comment id=edit-comment-1812>edit</a>
                <div class=comment-name>John Haugeland </div>
                <div class=comment-date>nine years ago </div>
                <div class=comment-text id="commentText1812">&quot;In modern languages, strings are immutable&quot;
<p>

<p>
LOL.  Novice zealot flag detected.  Article ignored. </div>
            </div>
        
                    <div class='article small-article'
            onclick='document.location.href="?id=115"'>
                <a class=title href='?id=115'>
                    <h1>Compressing dictionaries with a DAWG</h1>
                </a>
                
<img src='transparent.gif' osrc='http://zwibbler.com/shared/935.png' style='background: url(sprite.jpg); background-position: 0px -3228px;width:270px;height:108px'>
A practical, memory efficient way to store and search large sets of words.
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=130"'>
                <a class=title href='?id=130'>
                    <h1>VP trees: A data structure for finding stuff fast</h1>
                </a>
                
<img src='transparent.gif' osrc='http://stevehanov.ca/wavelet/cup.png' style='background: url(sprite.jpg); background-position: 0px -2202px;width:270px;height:218px'>
Let's say you have millions of pictures of faces tagged with names. Given a new photo, how do you find the name of person that the photo most resembles?
<p>
In the cases I mentioned, each record has hundreds or thousands of elements: the pixels in a photo, or patterns in a sound snippet, or web usage data. These records can be regarded as points in high dimensional space. When you look at a points in space, they tend to form clusters, and you can infer a lot by looking at ones nearby.

            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=105"'>
                <a class=title href='?id=105'>
                    <h1>Finding awesome developers in programming interviews</h1>
                </a>
                
In a job interview, I once asked a very experienced embedded software developer to write a program that reverses a string and prints it on the screen. He struggled with this basic task. This man was awesome. Give him a bucket of spare parts, and he could build a robot and program it to navigate around the room. He had worked on satellites that are now in actual orbit. He could have coded circles around me. But the one thing that he had never, ever needed to do was: display something on the screen.
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=128"'>
                <a class=title href='?id=128'>
                    <h1>Why you should go to the Business of Software Conference Next Year</h1>
                </a>
                
<img src='transparent.gif' osrc='http://stevehanov.ca/blog/whiskey_priest.jpg' style='background: url(sprite.jpg); background-position: 0px -2420px;width:270px;height:203px'>
Most people, having already paid $2000.00 of their hard earned money, and then having flown, driven, or otherwise travelled to Boston to attend a conference, and then having paid an additional $250/night plus $33/night parking and "tourism taxes" to the Seaport Hotel -- most people, after all this, are unlikely to say that it was a waste of time and they should have stayed home watching the remaining salvaged episodes of <i>Doctor Who</i> on Netflix.

<p>
In fact, I found it quite useful. 
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=56"'>
                <a class=title href='?id=56'>
                    <h1>How a programmer reads your resume (comic)</h1>
                </a>
                
<img src='transparent.gif' osrc='resume_comic.png' style='background: url(sprite.jpg); background-position: 0px -7111px;width:270px;height:501px'>
People thought it was a comic, so I never corrected them.
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=97"'>
                <a class=title href='?id=97'>
                    <h1>Creating portable binaries on Linux</h1>
                </a>
                
Distributing applications on Linux is hard. Sure, with modern package management, <i>installing</i> software is easy. But if you are <i>distributing</i> an application, you probably need one Windows version, plus umpteen different versions for Linux. In this article, we'll create a dummy application that targets the following operating systems, which are commonly used in business environments...
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=7"'>
                <a class=title href='?id=7'>
                    <h1>Rules for Effective C++</h1>
                </a>
                
The rules for safe C++ code are surprisingly controversial.
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=75"'>
                <a class=title href='?id=75'>
                    <h1>Pitching to VCs (comic)</h1>
                </a>
                
<img src='transparent.gif' osrc='../comics/comic_20090712.png' style='background: url(sprite.jpg); background-position: 0px -5592px;width:270px;height:82px'>
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=146"'>
                <a class=title href='?id=146'>
                    <h1>O(n) Delta Compression With a Suffix Array</h1>
                </a>
                
The difference between two sequences A and B can be compactly stored using COPY/INSERT operations. The greedy algorithm for finding these operations relies on an efficient way of finding the longest matching part of A of any given position in B. This article describes how to use a suffix array to find the optimal sequence of operations in time proportional to the length of the input sequences. As a preprocessing step, we find and store the longest match in A for every position in B in two passes over the suffix array. 
            </div>
                    <div class='article small-article'
            onclick='document.location.href="?id=61"'>
                <a class=title href='?id=61'>
                    <h1>Experiment: Deleting a post from the Internet</h1>
                </a>
                
<img src='transparent.gif' osrc='delreddit.png' style='background: url(sprite.jpg); background-position: 0px -6844px;width:270px;height:54px'>
Once you post something on the Internet, it is hard to get rid of it. As an experiment, I deleted one of my past posts, and I tried to remove all traces of it.
            </div>
            </div>
    </div>
    <script>
        var layout = new Layout({
            container: document.getElementById("main"),
            columnWidth: 350,
            maxCols: 3,
            margin: 10,
            fill: "#eee"
        });
        document.getElementById("main").style.visibility = "visible";

        function MakeAjaxRequest( strUrl, params, fnCallBack, param ) 
{
    var xmlHttpReq;

    try {
        xmlHttpReq = new XMLHttpRequest();
    } catch ( trymicrosoft ) {
        try {
            xmlHttpReq = new ActiveXObject("Msxml2.XMLHTTP");
        } catch(othermicrosoft) {
            try {
                xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
            } catch(failed) {
                xmlHttpReq = null;
            }
        }
    }

    xmlHttpReq.open('POST', strUrl, true);
    xmlHttpReq.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xmlHttpReq.onreadystatechange = function() {
        if (xmlHttpReq.readyState === 4) {
            var result = { status: "", json: null };
            if (xmlHttpReq.status === 200 ) {
                try {
                    //result.json = window.JSON.parse(xmlHttpReq.responseText);
                    result.json = eval("("+xmlHttpReq.responseText+")");
                    result.status = result.json["status"];
                } catch( e ) {
                    //alert(e);
                    result.status = "Error in server response";
                }
            } else if ( xmlHttpReq.message ) {
                result.status = xmlHttpReq.message;
            } else if ( xmlHttpReq.status === 0 ) {
                result.status = "Network error. Check internet connection";
            } else {
                result.status = 
                    "Server returned status " + xmlHttpReq.status;
            }
            fnCallBack( result );
        }
    };

    var query = "";
    var first = true;
    for ( var key in params ) {
        if ( params.hasOwnProperty( key ) ) {
            if ( !first ) {
                query += '&';
            } 
            first = false;
            query += key + "=" + encodeURIComponent(params[key]);
        }
    }

    xmlHttpReq.send(query);
}

function delcomment(id)
{
    elem = document.getElementById("comment"+id);
    MakeAjaxRequest(
        "index.php",
        {
            'delcomment': 1,
            'id': id,
            "password": ""
        },

        function( result ) {
            if ( result.status === "ok" ) {
                var box = document.getElementById("wholecomment" + id);
                $(box).slideUp("slow");
            } else {

            }
        },
        null
    );
    return null;
}

function rtrim( buffer )
{   
    var pos = buffer.length - 1;
    while( pos >= 0 && 
        ( buffer.charAt(pos) === ' ' ||
          buffer.charAt(pos) === '\t' ||
          buffer.charAt(pos) === '\r' ||
          buffer.charAt(pos) === '\n' ) ) {
        pos--;      
    }

    return buffer.substr(0, pos + 1);
}

function ltrim( buffer )
{   
    var pos = 0;
    while( pos < buffer.length && 
        ( buffer.charAt(pos) === ' ' ||
          buffer.charAt(pos) === '\t' ||
          buffer.charAt(pos) === '\r' ||
          buffer.charAt(pos) === '\n' ) ) {
        pos += 1;
    }

    return buffer.substr(pos);
}

function divToText( div )
{
    var stack = [div];
    var text = [];
    while( stack.length > 0 ) {
        var node = stack.pop();

        if ( node.nodeType === 1 && node.nodeName === "P" ) {
            var t = ltrim(rtrim(node.textContent));
            if ( t !== "" && t !== "Edit" ) {
                text.push(t);
                text.push("\n\n");
            }
        } else if ( node.nodeType === 3 ) {
            var t = ltrim(rtrim(node.data));
            if ( t !== "" && t !== "Edit" ) {
                text.push(t);
                text.push("\n\n");
            }

        } else {
            for ( node = node.lastChild;
                  node !== null;  
                  node = node.previousSibling )
            {
                stack.push( node );
            }
        }

    }

    return text.join("");
}

function textToDiv( div, text )
{
    while( div.firstChild !== null ) {
        div.removeChild( div.firstChild);
    }

    var arr = text.split("\n" );
    for ( var i = 0; i < arr.length; i++ ) {
        var p = document.createElement("p");
        p.appendChild( document.createTextNode(arr[i]));
        div.appendChild( p );
    }
}

var cancelFn = null;

function editcomment(id)
{
    if (cancelFn) {
        cancelFn();
    }

    var commentDiv = document.getElementById("commentText" + id);
    var textarea = document.createElement("textarea" );
    textarea.cols = 80;
    textarea.rows = 15;
    textarea.wrap = "soft";
    textarea.value = divToText( commentDiv );
    textarea.style.width = "100%";
    commentDiv.style.display = "none";

    var containerDiv = commentDiv.parentNode;
    var div = document.createElement("div");
    containerDiv.appendChild( div );

    div.appendChild(textarea);
    div.appendChild(document.createElement("br"));

    var passwordInput = document.createElement("input");
    passwordInput.type = "text";
    div.appendChild(document.createTextNode("Editing Password"));
    div.appendChild(passwordInput);
    div.appendChild(document.createElement("br"));
    
    var saveButton = document.createElement("input");
    saveButton.type = "button";
    saveButton.value = "Save Changes";
    div.appendChild(saveButton);

    var deleteButton = document.createElement("input");
    deleteButton.type = "button";
    deleteButton.value = "Delete Comment";
    div.appendChild(deleteButton);

    var cancelButton = document.createElement("input");
    cancelButton.type = "button";
    cancelButton.value = "Cancel";
    div.appendChild(cancelButton);

    var statusDiv = document.createElement("div");
    div.appendChild(statusDiv);
    statusDiv.style.color = "red";

    layout.go();
    textarea.focus();

    saveButton.onclick = function()
    {
        div.style.visibility = "hidden";
        MakeAjaxRequest(
            "index.php",
            {
                'editcomment': 1,
                'id': id,
                'text': textarea.value,
                "password": passwordInput.value
            },

            function( result ) {
                if ( result.status === "ok" ) {
                    containerDiv.removeChild(div);
                    commentDiv.style.display = "block";
                    textToDiv( commentDiv, textarea.value );
                    var adiv = document.createElement("div");
                    var a= document.createElement("a");
                    a.href="javascript:editcomment("+id+")";
                    a.appendChild(document.createTextNode("Edit"));
                    adiv.appendChild(a);
                    commentDiv.appendChild(adiv);
                } else {
                    div.style.visibility = "visible";
                    while( statusDiv.firstChild !== null ) {
                        statusDiv.removeChild( statusDiv.firstChild );
                    }
                    statusDiv.appendChild(document.createTextNode(result.status) );
                }
                layout.go();
                cancelFn = null;
            },
            null
        );
    };

    deleteButton.onclick = function()
    {
        if ( confirm( "Are you sure you want to delete this comment?" ) ) {
            div.style.visibility = "hidden";
            MakeAjaxRequest(
                "index.php",
                {
                    'delcomment': 1,
                    'id': id,
                    "password": passwordInput.value
                },

                function( result ) {
                    if ( result.status === "ok" ) {
                        var box = document.getElementById("wholecomment" + id);
                        box.parentNode.removeChild(box);
                    } else {
                        div.style.visibility = "visible";
                        while( statusDiv.firstChild !== null ) {
                            statusDiv.removeChild( statusDiv.firstChild );
                        }
                        statusDiv.appendChild(document.createTextNode(result.status) );
                    }
                    layout.go();
                    cancelFn = null;
                },
                null
            );
        }
    };

    cancelButton.onclick = function()
    {
        containerDiv.removeChild(div);
        commentDiv.style.display = "block";
        layout.go();
        cancelFn = null;
    };

    cancelFn = function() {
        cancelButton.onclick();
        cancelFn = null;
    }

}

function e(name) {
    return document.getElementById(name);
}

function writeComment() {
    document.getElementById("writecomment-div").style.display = "none";
    document.getElementById("commentForm").style.display = "block";
    layout.go();
    document.getElementById("comment-text").focus();
}

function cancelComment() {
    document.getElementById("writecomment-div").style.display = "block";
    document.getElementById("commentForm").style.display = "none";
    layout.go();
}

function validateCommentForm(form) {
    if (form.displayname.value == "") {
        alert("Please fill in the display name.");
        return false;
    }

    if (form.comment.value == "") {
        alert("Please fill in the comment.");
        return false;
    }

    if (form.comment.value.indexOf("http:") >= 0 || form.comment.value.indexOf("https:") >=
            0 ) {
        alert("You may not write http: in your comment.");
        return false;
    }
}

function mouseentercomment(id)
{
    e("edit-comment-" + id).style.color = "#000";
}

function mouseleavecomment(id)
{
    e("edit-comment-" + id).style.color = "#aaa";
}
    </script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
     Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-5751047-4', 'auto');
  ga('require', 'displayfeatures');
  ga('send', 'pageview');

</script>

</body>
</html>
